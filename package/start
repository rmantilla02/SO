LOGFILE=start
source ./log

# reporta si algo salió mal
function report() {
    echo -e "\e[1;31m$1\e[0m"
    echo -e "\e[1;31mTo repair the current system run './instalĺ -r'\e[0m"
}

while read LINE; do
    if [[ -z $LINE ]]; then continue; fi

    DIRS_KEY=$(echo "$LINE" | cut -d- -f1)
    DIRS_PATH=$(echo "$LINE" | cut -d- -f2)

    # SETEAR VARIABLES DE AMBIENTE
    case "$DIRS_KEY" in
        Executables) export EXECUTABLES=$DIRS_PATH;;
        Master) export MASTER=$DIRS_PATH;;
        Arrival) export ARRIVAL=$DIRS_PATH;;
        Accepted) export ACCEPTED=$DIRS_PATH;;
        Rejected) export REJECTED=$DIRS_PATH;;
        Processed) export PROCESSED=$DIRS_PATH;;
        Reports) export REPORTS=$DIRS_PATH;;
        Logs) export LOGS=$DIRS_PATH;;
    esac

done < "$HOME/Grupo06/.dirconf/installation.conf"

# VERIFICAR DIRECTORIOS
for DIRECTORY in EXECUTABLES MASTER ARRIVAL ACCEPTED REJECTED PROCESSED REPORTS LOGS; do
    if [ ! -v $DIRECTORY ]; then
        echo "There's no $DIRECTORY in the configuration file."
    elif [ ! -d ${!DIRECTORY} ]; then
        report "$DIRECTORY directory doesn't exist."
    fi
done

# VERIFICAR / CORREGIR PERMISOS
find "$MASTER" -type f -exec chmod u+r {} +
find "$EXECUTABLES" -type f -exec chmod u+x {} +
log "Permissions changed in Master and Executables files."
echo "Permissions changed in Master and Executables files."

# ARRANCAR EL DEMONIO
$EXECUTABLES/detectO.sh &
export PID_DEMON=$!
echo "Demon started with process ID $PID_DEMON."
